<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Video Torrent Stream via WebSocket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #status {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    #fileInfo {
      background: #e8f5e8;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    #error {
      background: #ffe8e8;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }
    .stat-box {
      background: #f8f8f8;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Video Torrent Streaming (MP4/MKV only)</h1>
  <div id="status">Connecting to WebSocket server...</div>
  <div id="fileInfo"></div>
  <div id="error"></div>
  
  <div class="stats">
    <div class="stat-box">
      <strong>Bytes Received</strong><br>
      <span id="totalBytes">0</span>
    </div>
    <div class="stat-box">
      <strong>Chunks Received</strong><br>
      <span id="chunkCount">0</span>
    </div>
  </div>

  <script>
    const statusDiv = document.getElementById('status');
    const fileInfoDiv = document.getElementById('fileInfo');
    const errorDiv = document.getElementById('error');
    const totalBytesSpan = document.getElementById('totalBytes');
    const chunkCountSpan = document.getElementById('chunkCount');
    
    const ws = new WebSocket('ws://localhost:3000');

    // Accumulate received bytes count
    let totalBytes = 0;
    let chunkCount = 0;
    let currentFile = null;

    ws.onopen = () => {
      statusDiv.textContent = 'Connected to WebSocket server. Waiting for video files...';
      console.log('WebSocket connection opened.');
    };

    ws.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        
        switch(message.type) {
          case 'connected':
            statusDiv.textContent = message.message;
            break;
            
          case 'fileInfo':
            currentFile = message;
            fileInfoDiv.innerHTML = `
              <strong>Streaming:</strong> ${message.name}<br>
              <strong>File Size:</strong> ${formatBytes(message.size)}<br>
              <strong>Video Files Found:</strong> ${message.totalFiles}
            `;
            fileInfoDiv.style.display = 'block';
            statusDiv.textContent = 'Streaming video file...';
            break;
            
          case 'chunk':
            // Process video chunk
            const chunkSize = message.size;
            totalBytes += chunkSize;
            chunkCount++;
            
            totalBytesSpan.textContent = formatBytes(totalBytes);
            chunkCountSpan.textContent = chunkCount.toLocaleString();
            
            if (currentFile) {
              const progress = ((totalBytes / currentFile.size) * 100).toFixed(1);
              statusDiv.textContent = `Streaming: ${progress}% (${formatBytes(totalBytes)} / ${formatBytes(currentFile.size)})`;
            }
            
            console.log(`Received chunk: ${chunkSize} bytes`);
            // Here you can process the video chunk data (message.data contains the byte array)
            break;
            
          case 'streamEnd':
            statusDiv.textContent = message.message;
            console.log('Stream ended:', message.message);
            break;
            
          case 'streamError':
            errorDiv.textContent = message.message;
            errorDiv.style.display = 'block';
            console.error('Stream error:', message.message);
            break;
            
          case 'error':
            errorDiv.textContent = message.message;
            errorDiv.style.display = 'block';
            statusDiv.textContent = 'No video files found in torrent';
            console.error('Error:', message.message);
            break;
            
          default:
            console.log('Unknown message type:', message.type);
        }
      } catch (err) {
        console.error('Error parsing message:', err);
      }
    };

    ws.onerror = (error) => {
      statusDiv.textContent = 'WebSocket error!';
      errorDiv.textContent = 'Connection error occurred';
      errorDiv.style.display = 'block';
      console.error('WebSocket error:', error);
    };

    ws.onclose = () => {
      statusDiv.textContent = 'WebSocket connection closed.';
      console.log('WebSocket connection closed.');
    };
    
    // Helper function to format bytes
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>
