<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Efficient Video Streamer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #444; }
        .input-section { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; }
        #magnetInput { width: calc(100% - 24px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 14px; }
        video { width: 100%; background: #000; border-radius: 5px; margin-top: 10px; }
        .actions { display: flex; justify-content: center; margin: 15px 0; gap: 10px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .logs { height: 150px; overflow-y: auto; background: #333; color: #f8f8f8; border: 1px solid #444; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 5px; white-space: pre-wrap; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center; font-weight: bold; }
        .status.connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Efficient Video Streamer</h1>
        
        <div id="status" class="status disconnected">Connecting to server...</div>
        
        <div class="input-section">
            <input type="text" id="magnetInput" placeholder="Enter magnet link or info hash">
            <div class="actions">
                <button id="startButton" onclick="startStream()" disabled>Start Stream</button>
                <button id="defaultButton" onclick="startDefault()" disabled>Play Default</button>
            </div>
        </div>
        
        <video id="videoPlayer" controls autoplay muted></video>
        <div class="logs" id="logs"></div>
    </div>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const magnetInput = document.getElementById('magnetInput');
        const logs = document.getElementById('logs');
        const status = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const defaultButton = document.getElementById('defaultButton');

        let ws;
        let isConnected = false;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[Log] ${message}`);
        }

        function updateStatus(connected) {
            isConnected = connected;
            if (connected) {
                status.textContent = 'Connected to server';
                status.className = 'status connected';
                startButton.disabled = false;
                defaultButton.disabled = false;
            } else {
                status.textContent = 'Disconnected from server';
                status.className = 'status disconnected';
                startButton.disabled = true;
                defaultButton.disabled = true;
            }
        }

        function startStream() {
            const magnetLink = magnetInput.value.trim();
            if (!magnetLink) {
                log('ERROR: Please enter a magnet link or hash.');
                return;
            }
            
            if (!isConnected) {
                log('ERROR: Not connected to server. Please wait for connection.');
                return;
            }
            
            log(`Requesting stream for: ${magnetLink.substring(0, 50)}...`);
            ws.send(JSON.stringify({ type: 'setMagnetLink', magnetLink }));
        }

        function startDefault() {
            if (!isConnected) {
                log('ERROR: Not connected to server. Please wait for connection.');
                return;
            }
            
            log('Requesting default stream...');
            ws.send(JSON.stringify({ type: 'startDefault' }));
        }

        function initializePlayer(streamUrl) {
            const fullUrl = `http://${window.location.hostname}:6543${streamUrl}`;
            log(`Setting player source to: ${fullUrl}`);
            videoPlayer.src = fullUrl;
            videoPlayer.play().catch(e => log(`Playback was prevented: ${e.message}`));
        }

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.hostname}:6543`);

            ws.onopen = () => {
                log('WebSocket connection established.');
                updateStatus(true);
            };

            ws.onclose = () => {
                log('WebSocket connection closed. Attempting to reconnect...');
                updateStatus(false);
                // Attempt to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                log('WebSocket error. See console for details.');
                console.error('WebSocket error:', err);
                updateStatus(false);
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    log(`Received message: ${msg.type}`);

                    if (msg.type === 'streamReady' && msg.url) {
                        initializePlayer(msg.url);
                    } else if (msg.type === 'error') {
                        log(`SERVER ERROR: ${msg.message}`);
                    }
                } catch (e) {
                    log('Error parsing server message.');
                    console.error('Parse error:', e);
                }
            };
        }

        // Start the connection when the page loads
        connectWebSocket();
    </script>
</body>
</html>